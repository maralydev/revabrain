# Progress Log — RevaBrain (Ralph loop)

## Codebase Patterns

- Tech stack: Next.js 16 (App Router), TypeScript, Tailwind CSS, Prisma ORM
- Database: SQLite (dev) → PostgreSQL (prod)
- Auth: Server-side enforcement, rollen: zorgverlener (eigen agenda) + admin (alles)
- Privacy: RR = PII, NOOIT loggen in plaintext, mask in UI

## Conventions

- Modulaire code: max 200-300 regels per bestand
- DRY principe strikt: herbruikbare componenten, geen dubbele logica
- Geen dependencies tenzij noodzakelijk
- Feature modules in `/modules/` of `/src/app/`
- Kleuren: Primary #2879D8, Accent #59ECB7, Light #E7F6FC, Dark #212529

## Learnings

### 2026-01-25 22:30 - US-000: Project bootstrap & authenticatie (MVP)

**Wat gebouwd:**
- Auth flow met login/logout (server actions)
- Role-based access control (middleware + helpers)
- JWT sessions (jose library)
- Login UI page
- Test users script (better-sqlite3)
- Prisma schema + migrations

**Dependencies toegevoegd:**
- bcryptjs (password hashing)
- jose (JWT tokens, lightweight)
- better-sqlite3 (seed scripts)
- @types/bcryptjs, @types/better-sqlite3

**Belangrijke beslissingen:**
- Prisma downgrade van 7.x naar 5.x (stabiliteit, geen adapters nodig voor SQLite)
- JWT tokens i.p.v. zwaardere session libraries (DRY principe)
- Direct SQL seed script met better-sqlite3 (vermijdt Prisma enum compatibiliteit issues)

**Commando's gedraaid:**
- `npx prisma migrate reset --force` (eerste keer, database reset met user consent)
- `npx prisma migrate dev --name initial_schema`
- `npx prisma generate`
- `npx tsx scripts/create-test-user.ts` (test users aanmaken)
- `npx tsc --noEmit` (typecheck ✅)
- `npm run build` (build ✅)

**Test credentials:**
- Admin: admin@revabrain.be / admin123
- Zorgverlener: zorgverlener@revabrain.be / zorgverlener123

**Valkuilen:**
- Prisma 7 vereist adapters voor SQLite → downgraded to Prisma 5
- SQLite ondersteunt geen native enums in sommige Prisma versies
- Middleware in Next.js 16: ⚠️ deprecated warning (gebruik "proxy" in toekomst)

**Volgende stappen:**
- US-006: Patiënt registratie met RR validatie

### 2026-01-25 23:15 - US-006: Nieuwe patiënt registreren (RR als primaire identifier)

**Wat gebouwd:**
- Patiënt registratie server action (validation + duplicate check)
- RR validatie met Belgische checksum (mod 97)
- Automatisch afleiden geboortedatum en geslacht uit RR
- Registratie formulier UI met real-time RR validatie
- Patiënten overzicht pagina (client-side data fetching)
- Prisma singleton pattern voor database connections

**Privacy & Security:**
- RR NOOIT gelogd in plaintext (commentaar in code)
- Dataminimalisatie: alleen noodzakelijke velden
- Server-side validation (requireZorgverlener)
- Duplicate RR detection

**Code structuur:**
- `/modules/patient/actions.ts` - Server actions (register)
- `/modules/patient/queries.ts` - Server actions (queries)
- `/app/admin/patient/page.tsx` - Overzicht (client component)
- `/app/admin/patient/nieuw/page.tsx` - Registratie formulier
- `/shared/lib/prisma.ts` - Prisma singleton (DRY)

**Belangrijke beslissingen:**
- Client-side data fetching i.p.v. server components (Next.js 16 Turbopack build issues)
- Prisma singleton pattern (voorkomt multiple instances, build errors)
- Bestaande RR utility hergebruikt (geen nieuwe dependencies)

**Commando's gedraaid:**
- `npx tsc --noEmit` (typecheck ✅)
- `npm run build` (build ✅)

**Valkuilen:**
- Server components + Prisma in Next.js 16 Turbopack build = errors
- Oplossing: client components + server actions voor data fetching
- Prisma singleton essentieel om connection pool problemen te vermijden

**Volgende stappen:**
- US-007: Patiënt zoeken (naam of RR)

### 2026-01-25 23:30 - US-007: Patiënt zoeken (naam of RR)

**Wat gebouwd:**
- Search server action met multi-field search (naam + RR)
- Debounced typeahead search (300ms delay)
- Real-time resultaten tijdens typen
- Laatste afspraak datum in search results
- Loading indicator tijdens search

**Search functionaliteit:**
- Zoek op voornaam OF achternaam (partial match)
- Zoek op RR (partial match, minimaal 3 cijfers)
- Resultaten tonen: naam, RR (gemaskeerd), geboortedatum, telefoon, gemeente, laatste afspraak
- Max 20 resultaten per query
- Minimaal 2 karakters vereist voor search

**Code wijzigingen:**
- `/modules/patient/queries.ts` - searchPatients() functie + PatientWithLastAfspraak type
- `/app/admin/patient/page.tsx` - Search UI met debouncing

**Belangrijke beslissingen:**
- 300ms debounce om aantal server requests te beperken
- SQLite ondersteunt geen case-insensitive search (mode: 'insensitive' niet beschikbaar)
- Oplossing: contains zonder mode (werkt voor meeste cases)
- Type PatientWithLastAfspraak voor search results met afspraak data

**Commando's gedraaid:**
- `npx tsc --noEmit` (typecheck ✅)
- `npm run build` (build ✅)

**Valkuilen:**
- SQLite + Prisma 5 ondersteunt geen `mode: 'insensitive'` in queries
- Oplossing: gebruik contains zonder mode, works for most cases
- Voor echte case-insensitive search: data in lowercase opslaan of PostgreSQL gebruiken

**Volgende stappen:**
- US-003: Dag/week overzicht (agenda views)

### 2026-01-25 23:45 - US-001: Afspraak inplannen (CRUD - create)

**Wat gebouwd:**
- Server action createAfspraak met conflict detection
- Conflict detection met time overlap logic (start/eind tijd checks)
- Query functions getAfsprakenByDate en getAfsprakenByWeek
- Appointment creation form met patient search typeahead
- Datum/tijd picker, duur selector (30/45/60/90 min), type selector
- Conflict warning display in UI

**Code structuur:**
- `/modules/afspraak/actions.ts` - createAfspraak, checkConflicts, ConflictInfo type
- `/modules/afspraak/queries.ts` - getAfsprakenByDate, getAfsprakenByWeek, AfspraakWithRelations type
- `/app/admin/afspraak/nieuw/page.tsx` - Creation form UI

**Conflict detection logica:**
- Berekent eind tijd: startTijd + duur (in milliseconds)
- Zoekt overlappende afspraken (OR query met time ranges)
- Filtert resultaten met actual time overlap check
- Blokkeert creatie als conflicten bestaan, toont conflictlijst

**Belangrijke beslissingen:**
- Nieuwe afspraak krijgt status 'TE_BEVESTIGEN' bij creatie
- Patient search hergebruikt searchPatients uit patient module (DRY)
- Conflict detection exclude parameter voor toekomstig edit gebruik
- AfspraakWithRelations type voor queries met patient + zorgverlener relations

**Commando's gedraaid:**
- `npx tsc --noEmit` (typecheck ✅ - na fix any types)
- `npm run build` (build ✅ - na clean)

**Valkuilen:**
- TypeScript implicit any in filter/map callbacks → fix met explicit `any` type annotation
- Build error ENOTEMPTY .next/server → fix met `rm -rf .next`

**Volgende stappen:**
- US-002: Afspraak wijzigen (CRUD - update)

### 2026-01-26 00:15 - US-003: Dag/week overzicht (agenda views)

**Wat gebouwd:**
- DagView component (bestaand, werkt met real data nu)
- WeekView component (nieuw, 7-day grid)
- View toggle in AgendaHeader (DAG/WEEK buttons)
- Week navigation (prev/next moves 7 days in week view)
- Real data integration: hooks updated from dummy data to server actions
- Teamlid query function getActieveTeamleden
- Status colors via STATUS_CONFIG (already existed)

**Code structuur:**
- `/modules/teamlid/queries.ts` - getActieveTeamleden server action
- `/modules/agenda/hooks/useAgenda.ts` - updated useAfspraken, useZorgverleners
- `/modules/agenda/components/WeekView.tsx` - new week grid component
- `/modules/agenda/components/AgendaHeader.tsx` - added view toggle
- `/app/admin/agenda/page.tsx` - supports both dag and week views

**Real data integration:**
- useAfspraken: calls getAfsprakenByDate, transforms AfspraakWithRelations to Afspraak
- useZorgverleners: calls getActieveTeamleden, transforms Teamlid to Zorgverlener
- Week view: calls getAfsprakenByWeek for entire week data
- Colors assigned cyclically from palette: #2879D8, #59ECB7, #9C27B0, #FFC107, #4CAF50

**UI patterns:**
- DagView: grid met uren (8-19) en kolommen per zorgverlener
- WeekView: grid met uren en kolommen per dag (7 dagen)
- Status shown via colored left border + dot (STATUS_CONFIG)
- Today highlighted in blue
- Nieuwe afspraak button → redirects to /admin/afspraak/nieuw

**Belangrijke beslissingen:**
- Week starts on Monday (Belgian convention)
- Separate hooks/queries for dag vs week (performance)
- Transform database types to agenda module types (separation of concerns)
- DRY: reuse existing AfspraakCard component for both views

**Commando's gedraaid:**
- `npx tsc --noEmit` (typecheck ✅ - after clean)
- `npm run build` (build ✅)

**Valkuilen:**
- Stale .next types causing duplicate identifier errors → fix met `rm -rf .next`
- Needed to export AgendaView type from module index for external imports

**Volgende stappen:**
- US-005b: Afspraak annuleren/verwijderen (CRUD - delete + cancel)

### 2026-01-26 00:30 - US-002: Afspraak wijzigen (CRUD - update)

**Wat gebouwd:**
- updateAfspraak server action met conflict detection
- getAfspraakById query function voor ophalen afspraak details
- Edit page /admin/afspraak/[id]/edit met formulier
- Afspraak click handler in agenda (navigeert naar edit page)
- Access control: zorgverlener kan alleen eigen afspraken wijzigen (admin kan alles)

**Code structuur:**
- `/modules/afspraak/actions.ts` - updateAfspraak action
- `/modules/afspraak/queries.ts` - getAfspraakById query
- `/app/admin/afspraak/[id]/edit/page.tsx` - Edit formulier
- `/app/admin/agenda/page.tsx` - handleAfspraakClick

**Update logica:**
- Laad bestaande afspraak data via getAfspraakById
- Prefill formulier met huidige waarden
- Bij wijziging datum/duur: conflict check met excludeAfspraakId (exclude current)
- Access check: alleen eigen afspraken of admin
- Partial update: alleen gewijzigde velden worden doorgegeven

**Conflict detection:**
- Hergebruikt checkConflicts functie uit create action
- excludeAfspraakId parameter voorkomt conflict met zichzelf
- Toont conflicterende afspraken indien overlap

**UI patterns:**
- Afspraak clickable in DagView en WeekView
- Edit page identiek qua UX aan create page (consistency)
- Patient selector herbruikbaar
- Datum/tijd picker prefilled met bestaande waarden

**Commando's gedraaid:**
- `npx tsc --noEmit` (typecheck ✅)
- `npm run build` (build ✅)

**Valkuilen:**
- Typo "const nieuweD datum" → fixed
- Dynamic route [id] requires getStaticParams of server-side rendering (Next.js handles)

**Nog te implementeren:**
- Herhalende reeksen: keuze "alleen deze" vs "hele reeks" (US-004 eerst)

**Volgende stappen:**
- US-005: Afspraak status wijzigen (workflow)

### 2026-01-26 00:45 - US-005b: Afspraak annuleren/verwijderen (CRUD - delete + cancel)

**Wat gebouwd:**
- cancelAfspraak action: zet status naar GEANNULEERD
- deleteAfspraak action: permanent delete met audit logging
- Cancel + Delete buttons in edit page (danger zone)
- Confirmation dialogs (browser confirm)
- AfspraakCard toont geannuleerde afspraken met opacity + strikethrough
- Audit logging zonder PII (alleen ID, datum, type, deletedBy)

**Code structuur:**
- `/modules/afspraak/actions.ts` - cancelAfspraak, deleteAfspraak
- `/app/admin/afspraak/[id]/edit/page.tsx` - handleCancel, handleDelete, UI buttons
- `/modules/agenda/components/AfspraakCard.tsx` - isCancelled styling

**Cancel functionaliteit:**
- Zet status op GEANNULEERD (blijft in database)
- Afspraak blijft zichtbaar in agenda
- Visual styling: opacity-60 + line-through text
- Access control: alleen eigen afspraken (of admin)

**Delete functionaliteit:**
- Permanent verwijdering uit database
- Confirmation dialog: "PERMANENT wilt verwijderen? Dit kan niet ongedaan gemaakt worden"
- Audit log: ID, datum, type, deletedBy (GEEN patient naam of RR)
- Access control: alleen eigen afspraken (of admin)

**UI patterns:**
- Danger zone section in edit page (separate from normal actions)
- Orange border voor Cancel, Red border voor Delete
- Explanatory text: verschil tussen cancel en delete
- Geannuleerde afspraken: 60% opacity + strikethrough all text

**Commando's gedraaid:**
- `npx tsc --noEmit` (typecheck ✅)
- `npm run build` (build ✅ - after clean)

**Valkuilen:**
- Build error ENOENT pages-manifest.json → fix met `rm -rf .next`

**Nog te implementeren:**
- Herhalende reeksen: keuze "alleen deze" vs "alle toekomstige" (pending US-004)
- Soft delete option (currently hard delete, but with logging)

**Volgende stappen:**
- US-004: Herhalende afspraken (reeks boeken)

### 2026-01-26 01:00 - US-005: Afspraak status wijzigen (workflow)

**Wat gebouwd:**
- updateAfspraakStatus server action
- Status dropdown in edit page met direct save
- All 7 statuses available: TE_BEVESTIGEN, BEVESTIGD, IN_WACHTZAAL, BINNEN, AFGEWERKT, NO_SHOW, GEANNULEERD
- Status change visible in agenda via STATUS_CONFIG colors (already implemented in US-003)

**Code structuur:**
- `/modules/afspraak/actions.ts` - updateAfspraakStatus action, AfspraakStatus type
- `/app/admin/afspraak/[id]/edit/page.tsx` - status dropdown, handleStatusChange

**Functionaliteit:**
- Status dropdown saves immediately on change (geen save button)
- Access control: alleen eigen afspraken (of admin)
- Status visible in agenda via colored left border (STATUS_CONFIG)
- User feedback: "Statuswijziging wordt direct opgeslagen" text

**UI patterns:**
- Dropdown placed after Notities, before Conflicts
- Direct save (onChange handler calls server action)
- Status state updated optimistically on success
- Error handling displays error message

**Commando's gedraaid:**
- `npx tsc --noEmit` (typecheck ✅)
- `npm run build` (build ✅)

**Volgende stappen:**
- US-004: Herhalende afspraken (reeks boeken)
