# Progress Log — RevaBrain (Ralph loop)

## Codebase Patterns

- Tech stack: Next.js 16 (App Router), TypeScript, Tailwind CSS, Prisma ORM
- Database: SQLite (dev) → PostgreSQL (prod)
- Auth: Server-side enforcement, rollen: zorgverlener (eigen agenda) + admin (alles)
- Privacy: RR = PII, NOOIT loggen in plaintext, mask in UI

## Conventions

- Modulaire code: max 200-300 regels per bestand
- DRY principe strikt: herbruikbare componenten, geen dubbele logica
- Geen dependencies tenzij noodzakelijk
- Feature modules in `/modules/` of `/src/app/`
- Kleuren: Primary #2879D8, Accent #59ECB7, Light #E7F6FC, Dark #212529

## Learnings

### 2026-01-25 22:30 - US-000: Project bootstrap & authenticatie (MVP)

**Wat gebouwd:**
- Auth flow met login/logout (server actions)
- Role-based access control (middleware + helpers)
- JWT sessions (jose library)
- Login UI page
- Test users script (better-sqlite3)
- Prisma schema + migrations

**Dependencies toegevoegd:**
- bcryptjs (password hashing)
- jose (JWT tokens, lightweight)
- better-sqlite3 (seed scripts)
- @types/bcryptjs, @types/better-sqlite3

**Belangrijke beslissingen:**
- Prisma downgrade van 7.x naar 5.x (stabiliteit, geen adapters nodig voor SQLite)
- JWT tokens i.p.v. zwaardere session libraries (DRY principe)
- Direct SQL seed script met better-sqlite3 (vermijdt Prisma enum compatibiliteit issues)

**Commando's gedraaid:**
- `npx prisma migrate reset --force` (eerste keer, database reset met user consent)
- `npx prisma migrate dev --name initial_schema`
- `npx prisma generate`
- `npx tsx scripts/create-test-user.ts` (test users aanmaken)
- `npx tsc --noEmit` (typecheck ✅)
- `npm run build` (build ✅)

**Test credentials:**
- Admin: admin@revabrain.be / admin123
- Zorgverlener: zorgverlener@revabrain.be / zorgverlener123

**Valkuilen:**
- Prisma 7 vereist adapters voor SQLite → downgraded to Prisma 5
- SQLite ondersteunt geen native enums in sommige Prisma versies
- Middleware in Next.js 16: ⚠️ deprecated warning (gebruik "proxy" in toekomst)

**Volgende stappen:**
- US-006: Patiënt registratie met RR validatie

### 2026-01-25 23:15 - US-006: Nieuwe patiënt registreren (RR als primaire identifier)

**Wat gebouwd:**
- Patiënt registratie server action (validation + duplicate check)
- RR validatie met Belgische checksum (mod 97)
- Automatisch afleiden geboortedatum en geslacht uit RR
- Registratie formulier UI met real-time RR validatie
- Patiënten overzicht pagina (client-side data fetching)
- Prisma singleton pattern voor database connections

**Privacy & Security:**
- RR NOOIT gelogd in plaintext (commentaar in code)
- Dataminimalisatie: alleen noodzakelijke velden
- Server-side validation (requireZorgverlener)
- Duplicate RR detection

**Code structuur:**
- `/modules/patient/actions.ts` - Server actions (register)
- `/modules/patient/queries.ts` - Server actions (queries)
- `/app/admin/patient/page.tsx` - Overzicht (client component)
- `/app/admin/patient/nieuw/page.tsx` - Registratie formulier
- `/shared/lib/prisma.ts` - Prisma singleton (DRY)

**Belangrijke beslissingen:**
- Client-side data fetching i.p.v. server components (Next.js 16 Turbopack build issues)
- Prisma singleton pattern (voorkomt multiple instances, build errors)
- Bestaande RR utility hergebruikt (geen nieuwe dependencies)

**Commando's gedraaid:**
- `npx tsc --noEmit` (typecheck ✅)
- `npm run build` (build ✅)

**Valkuilen:**
- Server components + Prisma in Next.js 16 Turbopack build = errors
- Oplossing: client components + server actions voor data fetching
- Prisma singleton essentieel om connection pool problemen te vermijden

**Volgende stappen:**
- US-007: Patiënt zoeken (naam of RR)

### 2026-01-25 23:30 - US-007: Patiënt zoeken (naam of RR)

**Wat gebouwd:**
- Search server action met multi-field search (naam + RR)
- Debounced typeahead search (300ms delay)
- Real-time resultaten tijdens typen
- Laatste afspraak datum in search results
- Loading indicator tijdens search

**Search functionaliteit:**
- Zoek op voornaam OF achternaam (partial match)
- Zoek op RR (partial match, minimaal 3 cijfers)
- Resultaten tonen: naam, RR (gemaskeerd), geboortedatum, telefoon, gemeente, laatste afspraak
- Max 20 resultaten per query
- Minimaal 2 karakters vereist voor search

**Code wijzigingen:**
- `/modules/patient/queries.ts` - searchPatients() functie + PatientWithLastAfspraak type
- `/app/admin/patient/page.tsx` - Search UI met debouncing

**Belangrijke beslissingen:**
- 300ms debounce om aantal server requests te beperken
- SQLite ondersteunt geen case-insensitive search (mode: 'insensitive' niet beschikbaar)
- Oplossing: contains zonder mode (werkt voor meeste cases)
- Type PatientWithLastAfspraak voor search results met afspraak data

**Commando's gedraaid:**
- `npx tsc --noEmit` (typecheck ✅)
- `npm run build` (build ✅)

**Valkuilen:**
- SQLite + Prisma 5 ondersteunt geen `mode: 'insensitive'` in queries
- Oplossing: gebruik contains zonder mode, works for most cases
- Voor echte case-insensitive search: data in lowercase opslaan of PostgreSQL gebruiken

**Volgende stappen:**
- US-001: Afspraak inplannen (CRUD - create)
